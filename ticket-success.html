<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vantacard Payment Confirmation</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <style>
    .message-container {
      max-width: 600px;
      background-color: #363030;
      color: #333;
      border: 3px solid #c2c0c0;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
      font-size: 1.2rem;
      line-height: 1.5;
      text-align: center;
    }

    /* Fullscreen container for centering */
    .fullscreen-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 15px;
      background-color: black;
    }
  </style>

  <body>
    <div class="fullscreen-container">
      <div id="msg" class="message-container">Verification en cours...</div>
    </div>
    <div id="msgalert" class="modal">
      <!-- Modal content goes here -->
    </div>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/jquery.barfiller.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/config.js"></script>
    <script>
      const appUrl = `${apiConfig.apiUrl}`; // Ensure this is set correctly

      // Function to display messages
      const displayMessage = (message, type) => {
        const msgElement = document.getElementById("msg");
        msgElement.innerText = message;

        // Set styles based on the message type
        switch (type) {
          case "info":
            msgElement.style.color = "blue";
            break;
          case "error":
            msgElement.style.color = "red";
            break;
          case "success":
            msgElement.style.color = "green";
            break;
          default:
            msgElement.style.color = "black";
        }
      };

      let uuid = localStorage.getItem("uuid");
      let reference_uid_payment = localStorage.getItem("reference_uid_payment");

      if (uuid && reference_uid_payment) {
        displayMessage("Paiement en cours...", "info");

        fetch(`${appUrl}/api/payment/callback/${reference_uid_payment}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`Erreur de confirmation: ${res.statusText}`);
            }
            return res.json();
          })
          .then((callbackData) => {
            if (callbackData.data.result === "Success") {
              submitSubscriptionForm(); // Proceed with payment finalization
            } else {
              displayMessage(
                "La génération de votre carte a échoué. Veuillez réessayer.",
                "error"
              );
            }
          })
          .catch((error) => {
            console.error("Erreur:", error);
            displayMessage(
              "Erreur lors de la confirmation du paiement.",
              "error"
            );
          });
      }

      // Function to submit the subscription form and clear localStorage
      const submitSubscriptionForm = () => {
        $.ajax({
          url: `${appUrl}/api/admin-payer-ticket`,
          method: "POST",
          data: {
            uid: uuid,
          },
          success: function () {
            // Display success message and remove keys
            alert("Paiement confirmé avec succès!");
            localStorage.removeItem("uuid"); // Remove uuid from localStorage
            localStorage.removeItem("reference_uid_payment"); // Remove reference_uid_payment from localStorage

            $("#msgalert").modal("hide");
            window.location.href = "index.html"; // Redirect after payment success
          },
          error: function () {
            alert("Échec de la confirmation du paiement.");
            $("#msgalert").modal("hide");
          },
        });
      };
    </script>
  </body>
</html>
