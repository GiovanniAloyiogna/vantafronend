<!-- CSS Styles -->
<style>
  /* Enhanced styling for the message container */
  .message-container {
    max-width: 600px;
    background-color: #363030;
    color: #333;
    border: 3px solid #c2c0c0;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    font-size: 1.2rem;
    line-height: 1.5;
    text-align: center;
  }

  /* Fullscreen container for centering */
  .fullscreen-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    padding: 15px;
    background-color: black;
  }
</style>

<div class="fullscreen-container">
  <div id="msg" class="message-container">Renouvellement en cours...</div>
</div>

<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.nicescroll.min.js"></script>
<script src="js/jquery.barfiller.js"></script>
<script src="js/jquery.countdown.min.js"></script>
<script src="js/jquery.slicknav.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/config.js"></script>

<script>
  const appUrl = `${apiConfig.apiUrl}`; // Ensure this is set correctly

  // Function to display messages
  const displayMessage = (message, type) => {
    const msgElement = document.getElementById("msg");
    msgElement.innerText = message;

    // Set styles based on the message type
    switch (type) {
      case "info":
        msgElement.style.color = "blue";
        break;
      case "error":
        msgElement.style.color = "red";
        break;
      case "success":
        msgElement.style.color = "green";
        break;
      default:
        msgElement.style.color = "black";
    }
  };

  let uid = localStorage.getItem("transaction_uid_card_sell");
  let formData = JSON.parse(localStorage.getItem("card-data"));

  if (uid) {
    displayMessage("Renouvellement en cours...", "info");

    fetch(`${appUrl}/api/payment/callback/${uid}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((res) => {
        if (!res.ok) {
          throw new Error(`Erreur de confirmation: ${res.statusText}`);
        }
        return res.json();
      })
      .then((callbackData) => {
        if (callbackData.data.result === "Success") {
          submitSubscriptionForm();
        } else {
          displayMessage(
            "La génération de votre carte a échoué. Veuillez réessayer.",
            "error"
          );
        }
      })
      .catch((error) => {
        console.error("Erreur:", error);
        displayMessage("Erreur lors de la confirmation du paiement.", "error");
      });
  }

  const submitSubscriptionForm = () => {
    $.ajax({
      url: `${apiConfig.apiUrl}/api/abonnement`,
      method: "POST",
      data: formData,
      success: function () {
        displayMessage("Abonnement effectué avec succès!", "success");
      },
      error: function (error) {
        displayMessage("Erreur lors de la soumission des données.", "error");
        console.error(error);
      },
    });
  };
</script>
